<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Management</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <header>
        <nav>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="user-management.html">User Management</a></li>
                <li><a href="notifications.html">Notifications</a></li>
                <li><a href="payouts.html">Payouts</a></li>
                <li><a href="analytics.html">Analytics</a></li>
                <li><a href="project-management.html">Project Management</a></li>
                <li><a href="version-control.html">Version Control</a></li>
                <li><a href="reports.html">Reports</a></li>
                <li><a href="threads.html">Threads</a></li>
                <li><a href="collections.html">Collections</a></li>
                <li><a href="organizations.html">Organizations</a></li>
                <li><a href="settings.html">Settings</a></li>
            </ul>
        </nav>
        <h1>Project Management</h1>
    </header>
    <main>
        <section id="project-search">
            <h2>Search Projects</h2>
            <form id="search-form">
                <input type="text" id="search-query" placeholder="Search for projects..." required>
                <button type="submit">Search</button>
            </form>
            <div id="search-results"></div>
        </section>
        <section id="project-form">
            <h2>Create or Manage Projects</h2>
            <form id="create-project-form">
                <label for="project-name">Project Name:</label>
                <input type="text" id="project-name" required>
                
                <label for="project-description">Description:</label>
                <textarea id="project-description" required></textarea>
                
                <button type="submit">Create Project</button>
            </form>
        </section>
        <section id="project-list">
            <h2>Existing Projects</h2>
            <ul id="projects">
                <!-- List of projects will be populated here -->
            </ul>
        </section>
        <section id="project-details" style="display: none;">
            <h2>Project Details</h2>
            <div id="project-info"></div>
            <h3>Versions</h3>
            <div id="project-versions"></div>
        </section>
    </main>
    <script src="js/app.js"></script>
    <script src="js/api.js"></script>
    <script>
        // Search projects
        document.getElementById('search-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            let query = document.getElementById('search-query').value;
            if (!query) query = '*';
            try {
                const results = await searchProjects(query);
                displaySearchResults(results.hits);
            } catch (error) {
                console.error('Error searching projects:', error);
                document.getElementById('search-results').innerHTML = '<p>Error searching projects: ' + error.message + '</p>';
            }
        });

        function displaySearchResults(projects) {
            const resultsDiv = document.getElementById('search-results');
            resultsDiv.innerHTML = '';
            projects.forEach(project => {
                const projectDiv = document.createElement('div');
                projectDiv.className = 'project-item';
                projectDiv.innerHTML = `
                    <img src="${project.icon_url || 'https://via.placeholder.com/64'}" alt="${project.title}" width="64">
                    <h3>${project.title}</h3>
                    <p>${project.description}</p>
                    <button onclick="viewProject('${project.project_id}')">View Details</button>
                    <button onclick="viewChangelog('${project.project_id}')">View Changelog</button>
                `;
                resultsDiv.appendChild(projectDiv);
            });
        }

        async function viewProject(id) {
            try {
                const project = await getProject(id);
                const versions = await getProjectVersions(id);
                document.getElementById('project-info').innerHTML = `
                    <img src="${project.icon_url || 'https://via.placeholder.com/128'}" alt="${project.title}" width="128">
                    <h3>${project.title}</h3>
                    <p>${project.description}</p>
                `;
                document.getElementById('project-versions').innerHTML = versions.map(version => `
                    <div class="version-item">
                        <h4>${version.version_number}</h4>
                        <p>${version.changelog || 'No changelog'}</p>
                        <button onclick="downloadVersion('${version.files[0].url}')">Download</button>
                    </div>
                `).join('');
                document.getElementById('project-details').style.display = 'block';
            } catch (error) {
                console.error('Error fetching project:', error);
            }
        }

        async function viewChangelog(id) {
            try {
                const versions = await getProjectVersions(id);
                let changelog = `Changelog for ${id}:\n`;
                versions.forEach(version => {
                    changelog += `Version ${version.version_number}: ${version.changelog || 'No changelog'}\n`;
                });
                alert(changelog);
            } catch (error) {
                console.error('Error fetching changelog:', error);
            }
        }

        // Create project
        document.getElementById('create-project-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            const name = document.getElementById('project-name').value;
            const description = document.getElementById('project-description').value;
            try {
                const result = await manageProject({ 
                    title: name, 
                    description, 
                    slug: name.toLowerCase().replace(/[^a-z0-9-]/g, '-'), 
                    type: "mod", 
                    categories: [], 
                    status: "draft", 
                    requested_status: "approved", 
                    client_side: "required", 
                    server_side: "required" 
                });
                alert('Project created successfully!');
                loadProjects(); // Refresh list
            } catch (error) {
                console.error('Error creating project:', error);
                alert('Error creating project: ' + error.message);
            }
        });

        // Load projects on page load
        document.addEventListener('DOMContentLoaded', loadProjects);

        async function loadProjects() {
            try {
                const user = await getUserData();
                const results = await searchProjects('*', [["author:" + user.username]]);
                const projectsList = document.getElementById('projects');
                projectsList.innerHTML = '';
                results.hits.forEach(project => {
                    const li = document.createElement('li');
                    li.textContent = project.title;
                    projectsList.appendChild(li);
                });
            } catch (error) {
                console.error('Error loading projects:', error);
                document.getElementById('projects').innerHTML = '<li>Error loading projects: ' + error.message + '</li>';
            }
        }
    </script>
</body>
</html>